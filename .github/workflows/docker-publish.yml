name: GHCR Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: Image tag to publish (e.g. v0.0.1)
        required: true
        type: string

permissions:
  contents: read
  packages: write

concurrency:
  group: ghcr-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build_by_arch:
    name: Build ${{ matrix.component.name }} image (${{ matrix.arch.name }})
    runs-on: ${{ matrix.arch.runner }}
    strategy:
      fail-fast: false
      matrix:
        component:
          - name: gateway
            image: f4a-gateway
            dockerfile: f4a/cmd/gateway/Dockerfile
          - name: dispatch
            image: f4a-dispatch
            dockerfile: f4a/cmd/dispatch/Dockerfile
        arch:
          - name: amd64
            runner: ubuntu-24.04
          - name: arm64
            runner: ubuntu-24.04-arm

    steps:
      - name: Prepare registry owner
        id: owner
        shell: bash
        run: echo "value=${GITHUB_REPOSITORY_OWNER,,}" >> "${GITHUB_OUTPUT}"

      - name: Check out source
        uses: actions/checkout@v4
        with:
          path: f4a

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.component.dockerfile }}
          platforms: linux/${{ matrix.arch.name }}
          outputs: type=image,name=ghcr.io/${{ steps.owner.outputs.value }}/${{ matrix.component.image }},push-by-digest=true,name-canonical=true,push=true

      - name: Export digest
        shell: bash
        run: |
          set -euo pipefail
          digest="${{ steps.build.outputs.digest }}"
          if [[ -z "${digest}" || "${digest}" != sha256:* ]]; then
            echo "Build did not produce a valid digest: ${digest}"
            exit 1
          fi
          mkdir -p "${{ runner.temp }}/digests"
          printf '%s\n' "${digest}" > "${{ runner.temp }}/digests/${{ matrix.component.name }}-${{ matrix.arch.name }}.txt"

      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.component.name }}-${{ matrix.arch.name }}
          path: ${{ runner.temp }}/digests/${{ matrix.component.name }}-${{ matrix.arch.name }}.txt
          if-no-files-found: error
          retention-days: 1

  merge_manifest:
    name: Merge ${{ matrix.component.name }} manifest
    needs: build_by_arch
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        component:
          - name: gateway
            image: f4a-gateway
          - name: dispatch
            image: f4a-dispatch

    steps:
      - name: Prepare registry owner
        id: owner
        shell: bash
        run: echo "value=${GITHUB_REPOSITORY_OWNER,,}" >> "${GITHUB_OUTPUT}"

      - name: Download amd64 digest
        uses: actions/download-artifact@v4
        with:
          name: digest-${{ matrix.component.name }}-amd64
          path: ${{ runner.temp }}/digests

      - name: Download arm64 digest
        uses: actions/download-artifact@v4
        with:
          name: digest-${{ matrix.component.name }}-arm64
          path: ${{ runner.temp }}/digests

      - name: Resolve release tag and digests
        id: prep
        shell: bash
        env:
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          amd64_digest="$(tr -d '\n' < "${{ runner.temp }}/digests/${{ matrix.component.name }}-amd64.txt")"
          arm64_digest="$(tr -d '\n' < "${{ runner.temp }}/digests/${{ matrix.component.name }}-arm64.txt")"

          if [[ -z "${amd64_digest}" || -z "${arm64_digest}" ]]; then
            echo "Digest artifact was empty for ${{ matrix.component.name }}"
            exit 1
          fi
          if [[ "${amd64_digest}" != sha256:* || "${arm64_digest}" != sha256:* ]]; then
            echo "Invalid digest format for ${{ matrix.component.name }}"
            exit 1
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            release_tag="${GITHUB_REF_NAME}"
          else
            release_tag="${INPUT_TAG}"
          fi
          if [[ -z "${release_tag}" ]]; then
            echo "Release tag resolved empty"
            exit 1
          fi

          image="ghcr.io/${{ steps.owner.outputs.value }}/${{ matrix.component.image }}"
          echo "image=${image}" >> "${GITHUB_OUTPUT}"
          echo "release_tag=${release_tag}" >> "${GITHUB_OUTPUT}"
          echo "amd64_digest=${amd64_digest}" >> "${GITHUB_OUTPUT}"
          echo "arm64_digest=${arm64_digest}" >> "${GITHUB_OUTPUT}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifest
        shell: bash
        run: |
          set -euo pipefail
          docker buildx imagetools create \
            -t "${{ steps.prep.outputs.image }}:${{ steps.prep.outputs.release_tag }}" \
            "${{ steps.prep.outputs.image }}@${{ steps.prep.outputs.amd64_digest }}" \
            "${{ steps.prep.outputs.image }}@${{ steps.prep.outputs.arm64_digest }}"

      - name: Validate manifest platforms
        shell: bash
        run: |
          set -euo pipefail
          inspect_output="$(docker buildx imagetools inspect "${{ steps.prep.outputs.image }}:${{ steps.prep.outputs.release_tag }}")"
          printf '%s\n' "${inspect_output}"

          amd64_count="$(printf '%s\n' "${inspect_output}" | awk '/Platform:[[:space:]]+linux\/amd64$/ {count++} END {print count+0}')"
          arm64_count="$(printf '%s\n' "${inspect_output}" | awk '/Platform:[[:space:]]+linux\/arm64(\/v8)?$/ {count++} END {print count+0}')"
          if [[ "${amd64_count}" -ne 1 || "${arm64_count}" -ne 1 ]]; then
            echo "Expected exactly one linux/amd64 and one linux/arm64(/v8) manifest entry."
            echo "Found linux/amd64=${amd64_count}, linux/arm64=${arm64_count}"
            exit 1
          fi

      - name: Update latest tag
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail
          docker buildx imagetools create \
            -t "${{ steps.prep.outputs.image }}:latest" \
            "${{ steps.prep.outputs.image }}:${{ steps.prep.outputs.release_tag }}"
